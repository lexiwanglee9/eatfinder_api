<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "PingFang TC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #f9fafb;
      margin: 0;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 { margin: 8px 0 6px; text-align: center; font-size: 28px; }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 20px;
      text-align: center;
    }

    .layout { max-width: 480px; width: 100%; }

    /* è¡¨å–® */
    .form-card {
      background: #020617;
      padding: 16px;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      margin-bottom: 24px;
      border: 1px solid rgba(148,163,184,0.3);
    }
    label { display: block; margin: 8px 0 4px; font-size: 14px; color: #e5e7eb; }
    select, input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      font-size: 14px;
      margin-bottom: 4px;
      background: #020617;
      color: #f9fafb;
    }
    .form-row {
      display: flex;
      gap: 10px;
    }
    .form-row > div { flex: 1; }

    .primary-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f97316, #fb923c);
      border: none;
      border-radius: 999px;
      color: #111827;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 10px 25px rgba(249,115,22,0.5);
    }

    /* å¡ç‰‡å€ */
    .card-wrapper {
      position: relative;
      height: 380px;
      margin-bottom: 14px;
    }

    .card-placeholder {
      height: 100%;
      border-radius: 22px;
      border: 1px dashed rgba(148,163,184,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-size: 14px;
      text-align: center;
      padding: 0 24px;
    }

    /* é¤å»³å¡ç‰‡ */
    .card {
      position: absolute; inset: 0;
      background: #1e293b;
      border-radius: 22px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateY(12px) scale(0.96);
      transition: opacity 0.18s ease, transform 0.18s ease;
      box-shadow: 0 25px 40px rgba(0,0,0,0.5);
    }
    .card.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .card-image {
      height: 180px;
      width: 100%;
      background-size: cover;
      background-position: center;
    }

    .chip {
      display: inline-block;
      background: rgba(15,118,110,0.25);
      color: #5eead4;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      margin: 10px 16px 6px;
    }

    .card-title {
      font-size: 20px;
      font-weight: bold;
      margin: 0 16px 4px;
    }

    .status-open { color: #4ade80; font-size: 13px; margin-left:16px;}
    .status-closed { color: #f87171; font-size: 13px; margin-left:16px;}

    .info-line {
      font-size: 14px;
      margin: 4px 16px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .tag-row {
      margin: 8px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag {
      padding: 3px 8px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 999px;
    }

    .card-footer {
      margin-top: auto;
      padding: 12px 16px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* æ»‘å‹•æŒ‰éˆ• */
    .swipe-actions {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-bottom: 20px;
    }
    .swipe-btn {
      flex: 1;
      padding: 12px;
      border-radius: 999px;
      font-size: 16px;
      cursor: pointer;
    }
    .dislike {
      background: #1e293b;
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    .like {
      background: #f97316;
      color: #111;
      border: none;
    }

    /* æ”¶è—å€æ•´é«” */
    .liked-section {
      max-width: 480px;
      width: 100%;
      margin-top: 20px;
    }

    .liked-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .liked-header-title {
      font-size: 15px;
      font-weight: 600;
      color: #f9fafb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .liked-header-title span:first-child {
      font-size: 18px;
    }

    .liked-count {
      font-size: 13px;
      color: #9ca3af;
    }

    /* æ”¶è—å¡ç‰‡ */
    .liked-card {
      background: rgba(30,41,59,0.65);
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .liked-main {
      flex: 1;
      min-width: 0;
    }

    .liked-name a {
      font-weight: 600;
      font-size: 15px;
      color: #f8fafc;
      text-decoration: none;
    }

    .liked-name a:hover {
      text-decoration: underline;
    }

    .liked-address a {
      display: inline-block;
      font-size: 12px;
      color: #93c5fd;
      text-decoration: underline;
      margin-top: 3px;
    }

    .liked-tags {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .liked-tag-pill {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
      color: #e2e8f0;
    }

    .liked-meta {
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .liked-meta-top {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .liked-star {
      color: #fbbf24;
      font-size: 14px;
    }

    .liked-distance {
      font-size: 12px;
      margin-top: 6px;
      color: #cbd5e1;
    }

    .liked-index {
      margin-top: 4px;
      font-size: 11px;
      color: #64748b;
    }
  </style>
</head>

<body>
  <h1>ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h1>
  <div class="subtitle">æ»‘å¡æ±ºå®šä½ çš„å¤©é¸é¤å»³ âœ¨</div>

  <div class="layout">

    <!-- è¡¨å–® -->
    <div class="form-card">
      <div class="form-row">
        <div>
          <label>åˆ†é¡</label>
          <select id="category">
            <option value="æ—¥å¼">æ—¥å¼</option>
            <option value="ç¾å¼">ç¾å¼</option>
            <option value="æ³•å¼">æ³•å¼</option>
            <option value="ç¾©å¼">ç¾©å¼</option>
            <option value="éŸ“å¼">éŸ“å¼</option>
            <option value="å°å¼">å°å¼</option>
          </select>
        </div>
        <div>
          <label>é ç®—/äºº</label>
          <input type="number" id="budget" value="300">
        </div>
      </div>

      <label>åœ°å€ / åŸå¸‚</label>
      <input id="region" placeholder="ä¾‹ï¼šå°åŒ—å¸‚å¤§å®‰å€">

      <button id="startBtn" class="primary-btn">é–‹å§‹æŠ½é¤å»³ ğŸœ</button>
    </div>

    <!-- å¡ç‰‡ -->
    <div class="card-wrapper">
      <div id="cardPlaceholder" class="card-placeholder">
        æŒ‰ã€Œé–‹å§‹æŠ½é¤å»³ã€è®“ç¾é£Ÿæœå°‹å™¨å‘Šè¨´ä½ ä»Šå¤©åƒä»€éº¼ ğŸ±âœ¨
      </div>
      <div id="restaurantCard" class="card"></div>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="swipe-actions">
      <button id="dislikeBtn" class="swipe-btn dislike">ğŸ‘ ä¸è¦</button>
      <button id="likeBtn" class="swipe-btn like">â¤ï¸ å–œæ­¡</button>
    </div>

    <!-- æ”¶è—æ¸…å–® -->
    <div id="likedSection" class="liked-section" style="display:none;">
      <div id="likedList"></div>
    </div>

  </div>

  <script>
    // DOM elements
    const categoryEl = document.getElementById("category");
    const regionEl = document.getElementById("region");
    const budgetEl = document.getElementById("budget");
    const cardPlaceholder = document.getElementById("cardPlaceholder");
    const restaurantCard = document.getElementById("restaurantCard");
    const likedSectionEl = document.getElementById("likedSection");
    const likedListEl = document.getElementById("likedList");

    // ç‹€æ…‹
    let filteredList = [];
    let currentIndex = 0;

    let likedItems = [];
    try {
      const raw = localStorage.getItem("likedRestaurants");
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) likedItems = parsed.filter(Boolean);
      }
    } catch (e) {
      likedItems = [];
    }

    // ç¶å®šæŒ‰éˆ•
    document.getElementById("dislikeBtn").addEventListener("click", handleDislike);
    document.getElementById("likeBtn").addEventListener("click", handleLike);
    document.getElementById("startBtn").addEventListener("click", startSwipe);

    // ä¸€é€²é é¢å…ˆç•«å‡ºæ”¶è—
    updateLikedUI();

    // é–‹å§‹æŠ½é¤å»³
    async function startSwipe() {
      const categoryValue = categoryEl.value;
      const regionText = regionEl.value.trim();
      const budgetValue = Number(budgetEl.value);

      if (!regionText) {
        alert("è«‹å…ˆè¼¸å…¥åœ°å€ï¼Œä¾‹å¦‚ï¼šå°åŒ—å¸‚å¤§å®‰å€");
        return;
      }
      if (!budgetValue || budgetValue <= 0) {
        alert("è«‹è¼¸å…¥åˆç†çš„é ç®—é‡‘é¡");
        return;
      }

      cardPlaceholder.style.display = "flex";
      cardPlaceholder.innerHTML = "æ­£åœ¨å‘ Google å•æœ‰ä»€éº¼å¥½åƒçš„â€¦ ğŸ£";
      restaurantCard.classList.remove("visible");

      try {
        const res = await fetch(`/api/restaurants`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: categoryValue,
            regionText,
            budgetPerPerson: budgetValue
          })
        });

        if (!res.ok) throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤");

        const data = await res.json();

        filteredList = (data || []).map(r => ({
          ...r,
          category: categoryValue,
          budget: budgetValue,
          tags: [
            categoryValue,
            budgetValue < 300 ? "å¹³åƒ¹" : "å°å¥¢ä¾ˆ",
            r.rating >= 4.3 ? "é«˜è©•åˆ†" : null
          ].filter(Boolean)
        }));

        currentIndex = 0;

        if (!filteredList.length) {
          cardPlaceholder.style.display = "flex";
          cardPlaceholder.innerHTML = "é€™å€‹æ¢ä»¶æ‰¾ä¸åˆ°é¤å»³ QQ<br>è©¦è‘—æ›å€‹åœ°å€æˆ–é ç®—å§ï½";
          restaurantCard.classList.remove("visible");
          return;
        }

        showCurrentCard();
      } catch (err) {
        console.error(err);
        cardPlaceholder.style.display = "flex";
        cardPlaceholder.innerHTML = "è·Ÿ Google è¯çµ¡å¤±æ•—äº† QQ<br>ç¢ºèªå¾Œç«¯æœ‰æ²’æœ‰åœ¨è·‘æˆ– API Key è¨­å®šã€‚";
        restaurantCard.classList.remove("visible");
      }
    }

    // é¡¯ç¤ºç›®å‰å¡ç‰‡
    function showCurrentCard() {
      if (!filteredList.length || currentIndex >= filteredList.length) {
        showEndCard();
        return;
      }

      const r = filteredList[currentIndex];

      cardPlaceholder.style.display = "none";
      restaurantCard.classList.add("visible");

      restaurantCard.innerHTML = `
        <div class="card-image" style="background-image:url('${r.photo || ""}')"></div>
        <div class="chip">${r.category} Â· ç´„ ${r.budget} å…ƒ</div>
        <div class="card-title">${r.name}</div>
        ${
          r.openStatus === "ç‡Ÿæ¥­ä¸­"
            ? `<div class="status-open">ğŸŸ¢ ${r.openStatus}</div>`
            : `<div class="status-closed">ğŸ”´ ${r.openStatus}</div>`
        }
        <div class="info-line">
          ğŸ“ <a href="${r.googleMapsUrl || "#"}" target="_blank" style="color:#93c5fd;">
            ${r.address}
          </a>
        </div>
        <div class="info-line">ğŸ“ è·é›¢ï¼š${r.distanceKm} km</div>
        <div class="info-line">ğŸ“ ${r.phone || "ç„¡æä¾›"}</div>
        <div class="tag-row">
          ${(r.tags || []).map(t => `<span class="tag">${t}</span>`).join("")}
        </div>
        <div class="card-footer">
          <span>ä¸å–œæ­¡å°±ç¹¼çºŒæ»‘ï¼Œå–œæ­¡å°±æ”¶é€²å£è¢‹ã€‚</span>
          <a href="${r.googleMapsUrl || "#"}" target="_blank" style="color:#38bdf8;">åœ°åœ– â†—</a>
        </div>
      `;
    }

    // æ²’å¡ç‰‡æ™‚çš„ç•«é¢
    function showEndCard() {
      restaurantCard.classList.add("visible");
      cardPlaceholder.style.display = "none";

      if (!likedItems.length) {
        restaurantCard.innerHTML = `
          <div class="card-title" style="margin:16px;">ä»Šå¤©ä½ èª°éƒ½ä¸æ„› ğŸ˜­</div>
          <div class="info-line">å¯ä»¥å†æŒ‰ä¸€æ¬¡ã€Œé–‹å§‹æŠ½é¤å»³ã€ï¼Œå®‡å®™æœƒå†çµ¦ä½ ä¸€è¼ªæ–°åº—ã€‚</div>
        `;
        return;
      }

      const last = likedItems[likedItems.length - 1];

      restaurantCard.innerHTML = `
        <div class="card-image" style="background-image:url('${last.photo || ""}')"></div>
        <div class="chip">ğŸ’˜ ä½ çš„å¤©é¸é¤å»³</div>
        <div class="card-title">${last.name}</div>
        <div class="info-line">
          ğŸ“ <a href="${last.googleMapsUrl || "#"}" target="_blank" style="color:#93c5fd;">
            ${last.address}
          </a>
        </div>
        <div class="info-line">â­ ${last.rating ?? "â€”"} Â· è·é›¢ ${last.distanceKm} km</div>
        <div class="card-footer">
          <span>å°±è®“é€™å®¶æˆç‚ºä»Šå¤©çš„æ™šé¤å§ã€‚</span>
          <a href="${last.googleMapsUrl || "#"}" target="_blank" style="color:#38bdf8;">æ‰“é–‹åœ°åœ– â†—</a>
        </div>
      `;
    }

    // å·¦å³æŒ‰éˆ•
    function handleDislike() {
      if (!filteredList.length) return;
      currentIndex++;
      showCurrentCard();
    }

    function handleLike() {
      if (!filteredList.length || currentIndex >= filteredList.length) return;
      const r = filteredList[currentIndex];
      likedItems.push(r);
      saveLiked();
      updateLikedUI();
      currentIndex++;
      showCurrentCard();
    }

    // æ”¶è—æ¸…å–® UI
    function updateLikedUI() {
      if (!likedItems.length) {
        likedSectionEl.style.display = "none";
        likedListEl.innerHTML = "";
        return;
      }

      likedSectionEl.style.display = "block";

      const headerHtml = `
        <div class="liked-header">
          <div class="liked-header-title">
            <span>ğŸ“Œ</span>
            <span>æ”¶è—çš„é¤å»³</span>
          </div>
          <div class="liked-count">å…± ${likedItems.length} é–“</div>
        </div>
      `;

      const listHtml = likedItems
        .filter(Boolean)
        .map((r, idx) => {
          const link = r.googleMapsUrl || r.reservationUrl || "#";
          const tags = (r.tags || [])
            .map(t => `<span class="liked-tag-pill">${t}</span>`)
            .join("");

          return `
            <div class="liked-card">
              <div class="liked-main">
                <div class="liked-name">
                  <a href="${link}" target="_blank">${r.name}</a>
                </div>
                <div class="liked-address">
                  <a href="${link}" target="_blank">${r.address}</a>
                </div>
                <div class="liked-tags">${tags}</div>
              </div>
              <div class="liked-meta">
                <div class="liked-meta-top">
                  <span class="liked-star">â˜…</span>
                  <span>${r.rating ?? "â€”"}</span>
                </div>
                <div class="liked-distance">${r.distanceKm} km</div>
                <div class="liked-index">#${idx + 1}</div>
              </div>
            </div>
          `;
        })
        .join("");

      likedListEl.innerHTML = headerHtml + listHtml;
    }

    function saveLiked() {
      localStorage.setItem("likedRestaurants", JSON.stringify(likedItems));
    }
  </script>
</body>
</html>
